image: node:18

stages:
  - install
  - test
  - build
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/

variables:
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

install_dependencies:
  stage: install
  script:
    - npm ci --cache .npm --prefer-offline
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

lint:
  stage: test
  dependencies:
    - install_dependencies
  script:
    - npm run lint
  allow_failure: false

typecheck:
  stage: test
  dependencies:
    - install_dependencies
  script:
    - npm run typecheck
  allow_failure: false

unit_tests:
  stage: test
  dependencies:
    - install_dependencies
  script:
    - npm run test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days

test_coverage:
  stage: test
  dependencies:
    - install_dependencies
  script:
    - npm run test:coverage
    - echo "Coverage report generated"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    paths:
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    expire_in: 30 days
  allow_failure: false

build:
  stage: build
  dependencies:
    - install_dependencies
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

deploy_staging:
  stage: deploy
  dependencies:
    - build
  script:
    - echo "Deploying to staging environment..."
    - echo "Frontend build available in dist/"
    - echo "Deploy Lambda functions to AWS..."
    - echo "Update API Gateway configuration..."
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop
  when: manual

deploy_production:
  stage: deploy
  dependencies:
    - build
  script:
    - echo "Deploying to production environment..."
    - echo "Frontend build available in dist/"
    - echo "Deploy Lambda functions to AWS..."
    - echo "Update API Gateway configuration..."
  environment:
    name: production
    url: https://example.com
  only:
    - main
  when: manual

pages:
  stage: deploy
  dependencies:
    - build
    - test_coverage
  script:
    - mkdir -p public
    - cp -r dist/* public/ || true
    - cp -r coverage public/coverage || true
    - echo "<html><body><h1>AWS E-Commerce</h1><ul><li><a href='coverage/'>Coverage Report</a></li></ul></body></html>" > public/index.html
  artifacts:
    paths:
      - public
  only:
    - main
